services:
  backend:
    build:
      context: ../server
      dockerfile: docker/Dockerfile.local
    environment:
      - DJANGO_SETTINGS_MODULE=settings.local
    depends_on:
      db:
        condition: service_healthy
  frontend:
    build:
      context: ../client
      dockerfile: docker/Dockerfile.local
    environment:
      - VITE_COACH_BASE_URL=http://localhost:8000/api/v1
      - VITE_ENV=LOCAL
    command: npm run local
  docs:
    build:
      context: ../docs
      dockerfile: Dockerfile.local
    environment:
      - NODE_ENV=development
    command: npm start
  celery:
    build:
      context: ../server
      dockerfile: docker/Dockerfile.local
    environment:
      - DJANGO_SETTINGS_MODULE=settings.local

# Fresh rebuild profile - forces complete rebuild without cache
x-fresh-build: &fresh-build
  backend:
    build:
      context: ../server
      dockerfile: docker/Dockerfile.local
      no_cache: true
      args:
        - FRESH_BUILD=${FRESH_BUILD:-$(date +%s)}
  frontend:
    build:
      context: ../client
      dockerfile: docker/Dockerfile.local
      no_cache: true
      args:
        - FRESH_BUILD=${FRESH_BUILD:-$(date +%s)}
  docs:
    build:
      context: ../docs
      dockerfile: Dockerfile.local
      no_cache: true
      args:
        - FRESH_BUILD=${FRESH_BUILD:-$(date +%s)}
  celery:
    build:
      context: ../server
      dockerfile: docker/Dockerfile.local
      no_cache: true
      args:
        - FRESH_BUILD=${FRESH_BUILD:-$(date +%s)}

# From the project root run:
# COMPOSE_PROJECT_NAME=dev-coach-local docker compose --profile local -f docker/docker-compose.yml -f docker/docker-compose.local.yml up --build
# 
# For fresh rebuild:
# COMPOSE_PROJECT_NAME=dev-coach-local docker compose --profile local --profile fresh -f docker/docker-compose.yml -f docker/docker-compose.local.yml up --build
